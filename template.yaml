AWSTemplateFormatVersion: 2010-09-09
Description: visitor-management
Transform:
  - AWS::Serverless-2016-10-31

Parameters:
  # CognitoCustomDomainName:
  #   Type: String
  #   Description: Your custom domain name (e.g., auth.example.com)
  #   Default: login.alphinecodetech.click
  CognitoDomainPrefix:
    Type: String
    Default: login
    Description: The Cognito User Pool domain prefix
  AcmCertificateArn:
    Type: String
    Default: arn:aws:acm:us-east-1:121216464768:certificate/4f441ddb-b0d2-493d-b2d0-e5b3ed387553
    Description: The public certificate arn in us-east-1 region

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:
  # Each Lambda function is defined by properties:
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction

  # This is an API gateway associated with the getByIdFunction and putItemFunctions
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: '''OPTIONS, POST, GET'''
        AllowHeaders: '''Content-Type'''
        AllowOrigin: '''*''' #DO NOT USE THIS VALUE IN PRODUCTION - https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-cors.html

  # This is a Lambda function config associated with the source code: get-by-id.js
  getVisitorsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/get-visitors.getVisitorsHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP get method to get all items by id
        from a DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitorsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VisitorsTable
      Environment:
        Variables:
          # Make table name accessible as environment variable from function code during execution
          VISITORS_TABLE: !Ref VisitorsTable
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
      Events:
        Api:
          Type: Api
          Properties:
            Path: /visitors
            Method: GET
            RestApiId: !Ref ApiGatewayApi
            RequestParameters:
              - method.request.querystring.residentId:
                  Required: false

  # This is a Lambda function config associated with the source code: get-visit-requests
  getVisitRequestsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/get-visit-requests.getVisitRequestsHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP get method to get all items by id
        from a DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitorsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VisitRequestsTable
      Environment:
        Variables:
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
          # Make table name accessible as environment variable from function code during execution
          VISIT_REQUESTS_TABLE: !Ref VisitRequestsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /visit-requests
            Method: GET
            RestApiId: !Ref ApiGatewayApi
            RequestParameters:
              - method.request.querystring.residentId:
                  Required: false

  # Each Lambda function is defined by properties:
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction

  # This is a Lambda function config associated with the source code: get-by-id.js
  getVisitorByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/get-visitor-by-id.getVisitorByIdHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP get method to get one item by id
        from a DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitorsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VisitorsTable
      Environment:
        Variables:
          # Make table name accessible as environment variable from function code during execution
          VISITORS_TABLE: !Ref VisitorsTable
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
      Events:
        Api:
          Type: Api
          Properties:
            Path: /visitor/{id}
            Method: GET
            RestApiId: !Ref ApiGatewayApi

  # This is a Lambda function config associated with the source code: get-invite-by-token.mjs
  getInviteByTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/get-invite-by-token.getInviteByTokenHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP get method to get one item by id
        from a DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitorsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref InviteLinksTable
      Environment:
        Variables:
          # Make table name accessible as environment variable from function code during execution
          INVITE_LINKS_TABLE: !Ref InviteLinksTable
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
      Events:
        Api:
          Type: Api
          Properties:
            Path: /invite/{inviteToken}
            Method: GET
            RestApiId: !Ref ApiGatewayApi

  # This is a Lambda function config associated with the source code: get-visit-request-by-token.mjs
  getVisitRequestByTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/get-visit-request-by-token.getVisitRequestByTokenHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP get method to get one item by id
        from a DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitorsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VisitRequestsTable
      Environment:
        Variables:
          # Make table name accessible as environment variable from function code during execution
          VISIT_REQUESTS_TABLE: !Ref VisitRequestsTable
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
      Events:
        Api:
          Type: Api
          Properties:
            Path: /visit-request/{inviteToken}
            Method: GET
            RestApiId: !Ref ApiGatewayApi

  # Each Lambda function is defined by properties:
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction

  # This is a Lambda function config associated with the source code: put-item.js
  putVisitorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/put-visitor.putVisitorHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP post method to add one item to a
        DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitorsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VisitorsTable
      Environment:
        Variables:
          VISITORS_TABLE: !Ref VisitorsTable
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
          APP_FRONTEND_BASE_URL: https://vms.alphinecodetech.click
      Events:
        Api:
          Type: Api
          Properties:
            Path: /visitor
            Method: POST
            RestApiId: !Ref ApiGatewayApi

  putInviteLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/put-invite-link.putInviteLinkItemHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP post method to add one item to a
        DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the InviteLinksTable
        - DynamoDBCrudPolicy:
            TableName: !Ref InviteLinksTable
      Environment:
        Variables:
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
          APP_FRONTEND_BASE_URL: https://vms.alphinecodetech.click
          INVITE_LINKS_TABLE: !Ref InviteLinksTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /invite
            Method: POST
            RestApiId: !Ref ApiGatewayApi

  putVisitRequestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: src/handlers/put-visit-request.putVisitRequestHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A simple example includes a HTTP post method to add one item to a
        DynamoDB table.
      Policies:
        # Give Create/Read/Update/Delete Permissions to the VisitRequestsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref VisitRequestsTable
      Environment:
        Variables:
          # Make DynamoDB endpoint accessible as environment variable from function code during execution
          ENDPOINT_OVERRIDE: ''
          VISIT_REQUESTS_TABLE: !Ref VisitRequestsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /visit-request
            Method: POST
            RestApiId: !Ref ApiGatewayApi

  # Simple syntax to create a DynamoDB table with a single attribute primary key, more in
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlesssimpletable

  # DynamoDB table to store item: {id: &lt;ID&gt;, name: &lt;NAME&gt;}
  VisitorsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: VisitorsTable
      AttributeDefinitions:
        - AttributeName: registrationId
          AttributeType: S
      KeySchema:
        - AttributeName: registrationId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  InviteLinksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: InviteLinksTable
      AttributeDefinitions:
        - AttributeName: inviteToken
          AttributeType: S
      KeySchema:
        - AttributeName: inviteToken
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  VisitRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: VisitRequestsTable
      AttributeDefinitions:
        - AttributeName: inviteToken
          AttributeType: S
      KeySchema:
        - AttributeName: inviteToken
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # S3 Bucket to host single page app website
  WebSiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
  WebSiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebSiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Id: PolicyForCloudFrontPrivateContent
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref WebSiteBucket
                - /*
            Condition:
              StringEquals:
                AWS:SourceArn: !Join
                  - ''
                  - - 'arn:aws:cloudfront::'
                    - !Ref AWS::AccountId
                    - ':distribution/'
                    - !Ref CloudFrontDistribution
  # CloudFront Distribution for hosting the single page app website
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !GetAtt WebSiteBucket.RegionalDomainName
            Id: myS3Origin
            OriginAccessControlId: !GetAtt CloudFrontOriginAccessControl.Id
            S3OriginConfig:
              OriginAccessIdentity: ''
        Enabled: true
        DefaultRootObject: index.html
        HttpVersion: http2
        DefaultCacheBehavior:
          AllowedMethods:
            - DELETE
            - GET
            - HEAD
            - OPTIONS
            - PATCH
            - POST
            - PUT
          CachedMethods:
            - GET
            - HEAD
          TargetOriginId: myS3Origin
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          ViewerProtocolPolicy: allow-all
          MinTTL: 0
          DefaultTTL: 3600
          MaxTTL: 86400
        PriceClass: PriceClass_200
        Restrictions:
          GeoRestriction:
            RestrictionType: whitelist
            Locations:
              - US
              - CA
              - GB
              - DE
              - PH
              - AU
        Aliases:
          # Use Aliases to specify alternate domain names
          - alphinecodetech.click
          - vms.alphinecodetech.click
        ViewerCertificate:
          AcmCertificateArn: !Ref AcmCertificateArn
          MinimumProtocolVersion: TLSv1.2_2021
          SslSupportMethod: sni-only
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub ${WebSiteBucket} OAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  HostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: alphinecodetech.click
      HostedZoneConfig:
        Comment: Hosted zone for my visitor management application
    DeletionPolicy: Retain #Remove this if no charge after recreation.

  # Note that CNAMEs are not included here as they were only used for validation needed for public certificate request in ACM. It is a one time setup.
  # Alias record for the vms subdomain domain IPV4
  CloudFrontVMSAliasRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZone
      Name: vms.alphinecodetech.click
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2 # Global CloudFront Hosted Zone ID
        DNSName: !GetAtt CloudFrontDistribution.DomainName # Your CloudFront distribution's domain name
        EvaluateTargetHealth: false # Important for CloudFront

  # CognitoLoginAliasRecord:
  #   Type: AWS::Route53::RecordSet
  #   DependsOn:
  #     - CognitoUserPoolDomain # Wait for Cognito domain to be created first
  #   Properties:
  #     HostedZoneId: !Ref HostedZone
  #     Name: login.alphinecodetech.click
  #     Type: A
  #     AliasTarget:
  #       HostedZoneId: Z2FDTNDATAQYW2 # CloudFront's global zone ID
  #       DNSName: !GetAtt CognitoUserPoolDomain.CloudFrontDomain
  #       EvaluateTargetHealth: false

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: VisitorManagementCognitoUserPool
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      UsernameAttributes:
        - email
      AutoVerifiedAttributes: []
      Schema:
        - Name: phone_number
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: email
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: given_name
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: family_name
          AttributeDataType: String
          Required: false
          Mutable: true
      # Configure message customizations (email verification, password reset)
      # MessageConfigurations:
      #   EmailMessage: "..."
      #   EmailSubject: "..."
      # Configure MFA if desired
      # MfaConfiguration: OPTIONAL
      # SmsConfiguration:
      #   SmsSenderId: "..."
      #   SmsRegion: "..."
      # Configure user pool add-ons (advanced security features)
      # UserPoolAddOns:
      #   AdvancedSecurityMode: ENFORCED

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: VisitorManagementCognitoClient
      UserPoolId: !Ref CognitoUserPool
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      CallbackURLs:
        - https://vms.alphinecodetech.click/signin-callback
      LogoutURLs:
        - https://vms.alphinecodetech.click/signout-callback
      GenerateSecret: false
      SupportedIdentityProviders:
        - COGNITO
      AccessTokenValidity: 60 # in minutes
      IdTokenValidity: 60 # in minutes
      RefreshTokenValidity: 30 # in days
      TokenValidityUnits:
        AccessToken: minutes
        IdToken: minutes
        RefreshToken: days

  CognitoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Ref CognitoDomainPrefix
      UserPoolId: !Ref CognitoUserPool
      # CustomDomainConfig:
      #   CertificateArn: arn:aws:acm:us-east-1:121216464768:certificate/4f441ddb-b0d2-493d-b2d0-e5b3ed387553

      # AdminUser:
      #   Type: AWS::Cognito::UserPoolUser
      #   Properties:
      #     UserPoolId: !Ref CognitoUserPool
      #     Username: swissgear31@gmail.com
      #     DesiredDeliveryMediums:
      #       - EMAIL
      #     UserAttributes:
      #       - Name: email
      #         Value: swissgear31@gmail.com
      #       - Name: email_verified
      #         Value: 'true'
      #       - Name: given_name
      #         Value: Admin
      #       - Name: family_name
      #         Value: User
      #     MessageAction: SUPPRESS # Prevents sending welcome email
      #     ForceAliasCreation: false

Outputs:
  APIGatewayEndpoint:
    Description: API Gateway endpoint URL for Prod stage
    Value: !Sub https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  CloudFrontDistributionId:
    Description: CloudFront Distribution ID for hosting web front end
    Value: !Ref CloudFrontDistribution
  CloudFrontDistributionDomainName:
    Description: CloudFront Distribution Domain Name for accessing web front end
    Value: !GetAtt CloudFrontDistribution.DomainName
  WebS3BucketName:
    Description: S3 Bucket for hosting web frontend
    Value: !Ref WebSiteBucket
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient
  UserPoolDomainUrl:
    Description: Cognito User Pool Domain URL
    Value: !Sub https://${CognitoDomainPrefix}.auth.${AWS::Region}.amazoncognito.com
  AuthorityUrl:
    Description: Cognito User Pool Authority URL (for OIDC client)
    Value: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    LoggingConfig:
      LogFormat: JSON