AWSTemplateFormatVersion: "2010-09-09"
Description: Visitor Management Verified Permissions resources

Parameters:
  AdminGroupName:
    Type: String
  ResidentGroupName:
    Type: String
  GuardGroupName:
    Type: String

Resources:
  VisitorManagementPolicyStoreNew:
    Type: AWS::VerifiedPermissions::PolicyStore
    Properties:
      Schema:
        CedarJson: |
          {
            "VisitorManagement": {
                "entityTypes": {
                    "User": {
                        "memberOfTypes": [
                            "UserGroup"
                        ],
                        "shape": {
                            "type": "Record",
                            "attributes": {}
                        }
                    },
                    "Resource": {
                        "memberOfTypes": [],
                        "shape": {
                            "type": "Record",
                            "attributes": {}
                        }
                    },
                    "UserGroup": {
                        "memberOfTypes": [],
                        "shape": {
                            "type": "Record",
                            "attributes": {}
                        }
                    }
                },
                "actions": {
                    "showAdminBadge": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    },
                    "showGuardBadge": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    },
                    "searchVisitor": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    },
                    "registerVisitor": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    },                    
                    "inviteVisitor": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    },                    
                    "verifyVisitor": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    },                    
                    "browseVisitors": {
                        "appliesTo": {
                            "context": {
                                "type": "Record",
                                "attributes": {}
                            },
                            "principalTypes": [
                                "User"
                            ],
                            "resourceTypes": [
                                "Resource"
                            ]
                        }
                    }
                }
            }
          }
      ValidationSettings:
        Mode: STRICT

  AllowAdminGroupAccessPolicyNew:
    Type: AWS::VerifiedPermissions::Policy
    Properties:
      PolicyStoreId: !Ref VisitorManagementPolicyStoreNew
      Definition:
        Static:
          Statement: !Sub |
            permit (
                principal in VisitorManagement::UserGroup::"${AdminGroupName}",
                action in
                    [VisitorManagement::Action::"browseVisitors",
                    VisitorManagement::Action::"inviteVisitor",
                    VisitorManagement::Action::"registerVisitor",
                    VisitorManagement::Action::"searchVisitor",
                    VisitorManagement::Action::"verifyVisitor",
                    VisitorManagement::Action::"showAdminBadge"],
                resource == VisitorManagement::Resource::"visitorResource"
            );
  AllowResidentGroupAccessPolicy:
    Type: AWS::VerifiedPermissions::Policy
    Properties:
      PolicyStoreId: !Ref VisitorManagementPolicyStoreNew
      Definition:
        Static:
          Statement: !Sub |
            permit (
                principal in VisitorManagement::UserGroup::"${ResidentGroupName}",
                action in
                    [VisitorManagement::Action::"browseVisitors",
                    VisitorManagement::Action::"inviteVisitor",
                    VisitorManagement::Action::"registerVisitor"],
                resource == VisitorManagement::Resource::"visitorResource"
            );
  AllowGuardGroupAccessPolicyNew:
    Type: AWS::VerifiedPermissions::Policy
    Properties:
      PolicyStoreId: !Ref VisitorManagementPolicyStoreNew
      Definition:
        Static:
          Statement: !Sub |
            permit (
                principal in VisitorManagement::UserGroup::"${GuardGroupName}",
                action in [VisitorManagement::Action::"verifyVisitor",
                           VisitorManagement::Action::"searchVisitor",
                           VisitorManagement::Action::"showGuardBadge"],
                resource == VisitorManagement::Resource::"visitorResource"
            );

Outputs:
  VisitorManagementPolicyStoreNew:
    Value: !Ref VisitorManagementPolicyStoreNew
